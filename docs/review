# Executive Review: Clariona Backend Classification Pipeline

**Version**: 2.5  
**Date**: December 2024  
**Status**: ✅ Production Ready

---

## Executive Summary

The Clariona Backend has completed a comprehensive 6-week revamp of its classification and sentiment analysis pipeline. The system now provides enterprise-grade topic classification, issue detection, sentiment analysis with emotion detection, and comprehensive data aggregation capabilities. All components are fully configurable through a centralized, database-backed configuration system that enables runtime adjustments without code deployments.

---

## Pipeline Architecture

### Core Pipeline Flow

**Data Collection → Processing → Classification → Issue Detection → Aggregation → Storage**

1. **Data Collection**: Multi-source collection (Twitter, Facebook, News, YouTube, RSS, Radio, Instagram, TikTok)
2. **Deduplication**: Intelligent duplicate detection using similarity thresholds
3. **Topic Classification**: Hybrid keyword + embedding-based multi-topic assignment
4. **Sentiment Analysis**: Enhanced sentiment with emotion detection and weighted scoring
5. **Issue Detection**: Clustering-based issue identification with lifecycle management
6. **Aggregation**: Multi-dimensional sentiment aggregation with trend analysis
7. **Storage**: All results written to PostgreSQL database

---

## Complete Feature Set

### Week 1: Database Schema Foundation
- **Revamped Schema**: Complete database redesign with 8 new tables
- **Topic System**: `topics`, `mention_topics` tables with keyword groups and embeddings
- **Issue System**: `topic_issues`, `issue_mentions`, `topic_issue_links` for issue tracking
- **Sentiment System**: `sentiment_aggregations`, `sentiment_trends`, `topic_sentiment_baselines`
- **Enhanced Columns**: Emotion detection, influence weights, confidence weights in `sentiment_data`

### Week 2: Topic Classification System
- **Hybrid Classification**: Combines keyword matching (40% weight) and embedding similarity (60% weight)
- **Multi-Topic Assignment**: Each mention can be classified into up to 5 topics simultaneously
- **Configurable Thresholds**: Minimum score, confidence, keyword score, and embedding score thresholds
- **Topic Embeddings**: Pre-computed embeddings for all topics using OpenAI's embedding model
- **Keyword Groups**: Support for AND/OR logic in keyword matching
- **Confidence Scoring**: Topic assignment confidence based on match quality

### Week 3: Enhanced Sentiment Analysis
- **Emotion Detection**: 7-emotion classification (joy, sadness, anger, fear, surprise, disgust, neutral) using HuggingFace transformers
- **Influence Weighting**: Source-based influence weights (verified accounts, reach, engagement metrics)
- **Confidence Weighting**: Confidence scores based on text quality, source reliability, and analysis certainty
- **Weighted Sentiment Score**: Combines raw sentiment with influence and confidence weights
- **Sentiment Index**: 0-100 normalized sentiment index for easy interpretation
- **Emotion-Adjusted Severity**: Sentiment severity adjusted by detected emotions

### Week 4: Issue Detection System
- **Clustering-Based Detection**: Connected components clustering using embedding similarity and time proximity
- **Automatic Issue Creation**: New issues created from clusters that exceed similarity thresholds
- **Issue Matching**: Intelligent matching of new mentions to existing issues
- **Lifecycle Management**: Automatic state transitions (emerging → active → escalated → resolved)
- **Priority Calculation**: Multi-factor priority scoring (sentiment, volume, recency, velocity)
- **Per-Topic Issue Limits**: Maximum 20 issues per topic with automatic consolidation
- **Issue Metadata**: Title, description, first/last mention timestamps, mention counts

### Week 5: Aggregation & Trends
- **Multi-Dimensional Aggregation**: Sentiment aggregation by topic, issue, or entity
- **Time Window Support**: 15-minute, 1-hour, 24-hour, 7-day, and 30-day windows
- **Trend Calculation**: Automatic trend detection (improving, deteriorating, stable) with magnitude
- **Baseline Normalization**: Topic-specific sentiment baselines for normalized scoring
- **Distribution Tracking**: Sentiment and emotion distribution tracking across time periods
- **Historical Comparison**: Current period vs. previous period sentiment comparison

### Week 6: Testing & Optimization
- **Comprehensive Test Suite**: 10 test cases covering end-to-end pipeline, performance, edge cases
- **Concurrent Processing**: Safe parallel processing using `SELECT FOR UPDATE SKIP LOCKED`
- **Error Handling**: Robust error handling with graceful degradation
- **Performance Baseline**: 0.44 texts/second throughput, ~2.27 seconds per text
- **Database Integration**: Full database schema validation and integration testing

---

## Complete Configurability System

### Centralized Configuration Architecture

The system uses a **three-tier configuration hierarchy** with database backend support:

1. **Environment Variables** (Highest Priority): Deployment-specific overrides
2. **Database Configuration** (Runtime Editable): Frontend-accessible configuration via `SystemConfiguration` table
3. **File-Based Configuration** (Defaults): JSON config files for fallback values

### Configuration Categories

#### Processing Configuration
- **Parallel Processing**: Worker counts for collectors (8), sentiment (20), location (8)
- **Batch Sizes**: Sentiment batch size (150), location batch size (300)
- **Timeouts**: Collector (1000s), Apify (600s), HTTP requests (120s), lock max age (300s)
- **Limits**: Max records per batch (10,000)

#### Topic Classification Configuration
- **Thresholds**: Minimum score (0.2), confidence (0.85), keyword score (0.3), embedding score (0.5)
- **Weights**: Keyword weight (0.4), embedding weight (0.6)
- **Limits**: Maximum topics per mention (5)

#### Sentiment Analysis Configuration
- **Thresholds**: Positive threshold (0.2), negative threshold (-0.2), default neutral (0.5)
- **Emotion Model**: HuggingFace model name (configurable, default: j-hartmann/emotion-english-distilroberta-base)
- **Influence Weights**: Source type weights (news: 1.5, social: 1.0, blog: 0.8), verified boost (1.5)
- **Reach Thresholds**: High reach (100,000), medium reach (10,000) with corresponding boosts (1.3, 1.1)
- **Confidence Weights**: Text quality, source reliability, analysis certainty weights

#### Issue Detection Configuration
- **Clustering**: Similarity threshold (0.75), minimum cluster size (3), time window hours (24)
- **Issue Matching**: Issue similarity threshold (0.7)
- **Lifecycle**: Emerging threshold hours (24), resolved threshold days (7)
- **Priority Weights**: Sentiment weight (0.4), volume weight (0.3), time weight (0.2), velocity weight (0.1)
- **Limits**: Maximum issues per topic (20)

#### Aggregation Configuration
- **Minimum Mentions**: Minimum mentions required for aggregation (3)
- **Time Windows**: 15m, 1h, 24h, 7d, 30d (all configurable)
- **Trend Thresholds**: Improvement threshold (5.0), deterioration threshold (-5.0), stable threshold (2.0)

#### Normalization Configuration
- **Baseline Calculation**: Lookback days (30), minimum sample size (10)

#### LLM Configuration
- **Available Models**: gpt-5-mini, gpt-5-nano, gpt-4.1-mini, gpt-4.1-nano
- **Default Model**: gpt-5-nano
- **TPM Capacities**: Per-model token-per-minute limits
- **Embedding Model**: text-embedding-3-small

#### Prompt Configuration
- **Presidential Sentiment**: System message and user template (configurable with variables)
- **Governance Classification**: System message and user template
- **Issue Classification**: Comparison and consolidation prompt templates
- **Prompt Variables**: President name, country (runtime configurable)

#### Collector Configuration
- **Source-Specific Settings**: Timeouts, delays, retries, max results per collector
- **Incremental Collection**: Lookback days, max lookback, overlap hours per source
- **Keywords**: Per-collector keyword lists (configurable)
- **Source Mapping**: Collector-to-source mapping configuration

#### Deduplication Configuration
- **Similarity Threshold**: 0.85
- **Length Ratio Threshold**: 0.5

### Frontend-Based Database-Backed Configuration System

**Key Innovation**: All configuration values can be edited at runtime through the frontend without requiring code deployments or server restarts.

#### SystemConfiguration Table
- **Category-Based Organization**: Configuration grouped by category (processing, collectors, database, etc.)
- **Type-Safe Storage**: Supports int, float, bool, string, json, array types
- **Audit Trail**: Created/updated timestamps, updated_by user tracking
- **Active/Inactive Flags**: Enable/disable configuration values without deletion
- **Default Values**: Store default values alongside current values for reference

#### Frontend Integration
- **Direct Database Access**: Frontend applications read/write directly to `SystemConfiguration` table via Prisma
- **No Backend API Required**: Configuration changes bypass backend APIs entirely
- **Real-Time Updates**: Changes take effect on next configuration load (no restart needed)
- **Validation**: Configuration schema ensures valid value types and ranges

#### Configuration Access Pattern
- **ConfigManager**: Centralized accessor with dot-notation (e.g., `processing.topic.min_score_threshold`)
- **Priority Resolution**: Environment variables → Database → JSON files → Defaults
- **Type-Safe Accessors**: `get()`, `get_int()`, `get_float()`, `get_bool()`, `get_list()`, `get_dict()`
- **Fallback Handling**: Graceful fallback to defaults if configuration unavailable

#### Benefits
- **Zero-Downtime Configuration**: Update thresholds, weights, timeouts without deployments
- **A/B Testing**: Easy experimentation with different configuration values
- **Environment-Specific Tuning**: Different configurations for dev, staging, production
- **Business User Access**: Non-technical users can adjust thresholds via frontend UI
- **Audit Compliance**: Full audit trail of all configuration changes

---

## Performance Metrics

### Throughput
- **Baseline**: 0.44 texts/second
- **Batch Processing**: ~2.27 seconds per text
- **Concurrent Processing**: Safe parallel execution with database locking

### Scalability
- **Parallel Workers**: Configurable worker pools for collectors, sentiment, location processing
- **Batch Optimization**: Configurable batch sizes for optimal throughput
- **Database Pooling**: Connection pooling (30 pool size, 20 max overflow)

### Reliability
- **Error Handling**: Comprehensive error handling with graceful degradation
- **Retry Logic**: Configurable retry attempts and delays
- **Lock Management**: Database-level locking prevents race conditions

---

## Key Capabilities

### Multi-Source Data Collection
- **10+ Sources**: Twitter, Facebook, Instagram, TikTok, News, YouTube, RSS, Radio, Reddit, LinkedIn
- **Parallel Execution**: Concurrent collection from multiple sources
- **Incremental Collection**: Smart lookback windows with overlap handling

### Intelligent Classification
- **Multi-Topic**: Each mention classified into multiple topics simultaneously
- **Hybrid Approach**: Combines rule-based (keywords) and ML-based (embeddings) methods
- **Confidence Scoring**: All classifications include confidence scores

### Advanced Sentiment Analysis
- **Emotion-Aware**: 7-emotion detection enhances sentiment understanding
- **Weighted Scoring**: Influence and confidence weights provide accurate sentiment representation
- **Normalized Index**: 0-100 sentiment index for easy interpretation

### Issue Intelligence
- **Automatic Detection**: Clustering identifies emerging issues automatically
- **Lifecycle Tracking**: Full issue lifecycle from emerging to resolved
- **Priority Ranking**: Multi-factor priority calculation for issue prioritization

### Aggregation & Insights
- **Multi-Dimensional**: Aggregate by topic, issue, or entity
- **Time-Series Analysis**: Multiple time windows for trend analysis
- **Baseline Normalization**: Topic-specific baselines for accurate comparisons

---

## Database Schema

### Core Tables
- **sentiment_data**: Main data table with enhanced sentiment columns
- **topics**: Topic definitions with keywords and embeddings
- **mention_topics**: Many-to-many topic assignments
- **topic_issues**: Issue definitions with lifecycle and priority
- **issue_mentions**: Issue-to-mention mappings
- **topic_issue_links**: Topic-issue relationships
- **sentiment_aggregations**: Aggregated sentiment metrics
- **sentiment_trends**: Trend calculations
- **topic_sentiment_baselines**: Baseline sentiment per topic
- **system_configurations**: Database-backed configuration storage

### Indexing Strategy
- **Performance Indexes**: Strategic indexes on foreign keys, aggregation keys, timestamps
- **Query Optimization**: Indexes support fast lookups for aggregations and trends
- **Concurrent Safety**: Unique constraints prevent duplicate aggregations

---

## Technology Stack

### Core Technologies
- **Python 3.11+**: Backend language
- **FastAPI**: API framework
- **SQLAlchemy**: ORM for database interactions
- **PostgreSQL**: Primary database
- **Alembic**: Database migrations

### AI/ML Technologies
- **OpenAI GPT Models**: Sentiment and governance analysis
- **OpenAI Embeddings**: Text and topic embeddings (text-embedding-3-small)
- **HuggingFace Transformers**: Emotion detection (j-hartmann/emotion-english-distilroberta-base)
- **Cosine Similarity**: Embedding similarity calculations

### Infrastructure
- **ConfigManager**: Centralized configuration management
- **PathManager**: Centralized path management
- **Logging System**: Centralized logging with rotation
- **Error Handling**: Custom exception hierarchy

---

## Production Readiness

### Testing
- **Test Coverage**: Comprehensive test suite covering all pipeline components
- **Integration Tests**: Full database integration testing
- **Performance Tests**: Baseline performance metrics established
- **Edge Case Handling**: Tests for concurrent processing, error scenarios, data consistency

### Code Quality
- **Type Hints**: Comprehensive type annotations
- **Standardized Imports**: Consistent import order across modules
- **Error Handling**: Structured exception handling
- **Logging**: Centralized logging with configurable levels

### Documentation
- **Architecture Documentation**: Complete system architecture documentation
- **Developer Guide**: Comprehensive developer patterns and guidelines
- **Configuration Guides**: Guides for adding features, optimizing performance, improving throughput
- **API Documentation**: Complete API endpoint documentation

---

## Business Value

### Operational Efficiency
- **Automated Classification**: Reduces manual classification effort
- **Intelligent Issue Detection**: Proactive identification of emerging issues
- **Trend Analysis**: Historical trend insights for strategic decision-making

### Accuracy & Reliability
- **Hybrid Classification**: Combines rule-based and ML-based approaches for accuracy
- **Weighted Sentiment**: Influence and confidence weights ensure accurate sentiment representation
- **Baseline Normalization**: Topic-specific baselines enable accurate comparisons

### Flexibility & Scalability
- **Fully Configurable**: All thresholds, weights, and parameters configurable at runtime
- **Database-Backed Config**: Frontend-accessible configuration without deployments
- **Parallel Processing**: Scalable architecture supports high-volume processing

### Insights & Analytics
- **Multi-Dimensional Aggregation**: Aggregate sentiment by topic, issue, or entity
- **Time-Series Trends**: Track sentiment changes over time
- **Priority Ranking**: Intelligent issue prioritization for resource allocation

---

## Conclusion

The Clariona Backend classification pipeline is a production-ready, enterprise-grade system that provides comprehensive topic classification, sentiment analysis, issue detection, and aggregation capabilities. The fully configurable, database-backed configuration system enables runtime adjustments without code deployments, making it highly adaptable to changing business requirements. The system's hybrid approach combining rule-based and ML-based methods ensures high accuracy while maintaining interpretability and configurability.


